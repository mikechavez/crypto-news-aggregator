# Narrative Detection Rebuild: Theme-Based Clustering

## Summary

Successfully rebuilt the narrative detection system to use **theme-based clustering** instead of entity co-occurrence. This eliminates the duplicate narrative problem (68 duplicates → 10 focused narratives).

## Changes Made

### 1. Created `narrative_themes.py` Service

**File:** `src/crypto_news_aggregator/services/narrative_themes.py`

- **Theme extraction function** using Claude Sonnet
- Extracts themes from article titles + summaries
- Maps to predefined theme categories:
  - `regulatory` - SEC actions, legal frameworks, compliance
  - `defi_adoption` - DeFi protocols, TVL changes, yield farming
  - `institutional_investment` - Corporate adoption, ETFs, institutional flows
  - `payments` - Payment rails, merchant adoption, remittances
  - `layer2_scaling` - L2 solutions, rollups, scaling tech
  - `security` - Hacks, exploits, security audits
  - `infrastructure` - Node operators, validators, network upgrades
  - `nft_gaming` - NFTs, gaming, metaverse
  - `stablecoin` - Stablecoin regulation, depegs, adoption
  - `market_analysis` - Price action, trading volumes, market sentiment
  - `technology` - Protocol upgrades, new tech, research
  - `partnerships` - Collaborations, integrations, ecosystem growth

- Stores themes in `articles.themes[]` field
- Includes backfill function for existing articles

### 2. Updated `narrative_service.py`

**File:** `src/crypto_news_aggregator/services/narrative_service.py`

**Old approach (removed):**
- `find_cooccurring_entities()` - Found entities appearing together
- Created narratives based on entity overlap
- Result: 68 duplicate narratives

**New approach:**
- Groups articles by shared themes (not entity overlap)
- For each theme with 3+ articles in last 48 hours:
  - Extracts all entities mentioned across those articles
  - Generates narrative using Claude Sonnet
  - Tracks lifecycle stage

### 3. Enhanced Narrative Structure

**New fields added:**
```python
{
  "theme": "regulatory",              # Theme category
  "title": "SEC crypto enforcement...", # Generated title
  "summary": "Generated by Claude",   # AI summary
  "entities": ["SEC", "Coinbase"],    # Entities from articles
  "article_ids": [...],               # Supporting articles
  "first_seen": timestamp,            # When first detected
  "last_updated": timestamp,          # Last update
  "article_count": 15,                # Number of articles
  "mention_velocity": 7.5,            # Articles per day
  "lifecycle": "mature"               # Lifecycle stage
}
```

### 4. Lifecycle Tracking

**Stages:**
- **emerging**: 2-4 articles
- **hot**: 5-10 articles with high velocity (>2.0 articles/day)
- **mature**: 10+ articles or high sustained velocity (>3.0 articles/day)
- **declining**: Article count dropping compared to previous run

### 5. Updated Database Operations

**File:** `src/crypto_news_aggregator/db/operations/narratives.py`

- Updated `upsert_narrative()` to support full structure
- Added `lifecycle_filter` parameter to `get_active_narratives()`
- Updated indexes for new fields
- Changed field names: `updated_at` → `last_updated`

### 6. Updated API Endpoint

**File:** `src/crypto_news_aggregator/api/v1/endpoints/narratives.py`

- Updated `NarrativeResponse` model with new fields
- Returns lifecycle, mention_velocity, first_seen, etc.

## Test Results

**Command:** `poetry run python scripts/test_theme_narratives.py`

**Results:**
- ✅ Generated **10 theme-based narratives** (vs 68 duplicates before)
- ✅ Processed 96 recent articles (48 hours)
- ✅ Lifecycle distribution:
  - Hot: 3 narratives
  - Mature: 7 narratives
- ✅ Top themes by article count:
  - `market_analysis`: 60 articles (mature)
  - `institutional_investment`: 40 articles (mature)
  - `technology`: 35 articles (mature)
  - `payments`: 25 articles (mature)
  - `infrastructure`: 24 articles (mature)

## Example Narratives

### 1. Regulatory Narrative
- **Theme:** regulatory
- **Title:** "SEC Crypto Enforcement Actions Intensify"
- **Articles:** 15
- **Velocity:** 7.5 articles/day
- **Lifecycle:** mature
- **Entities:** SEC, Coinbase, Binance, Gary Gensler, Ripple, Kraken

### 2. Institutional Investment Narrative
- **Theme:** institutional_investment
- **Title:** "Institutional Crypto Adoption Accelerates"
- **Articles:** 40
- **Velocity:** 20.0 articles/day
- **Lifecycle:** mature
- **Entities:** BlackRock, Fidelity, Grayscale, Bitcoin ETF, Ethereum ETF

## Benefits

1. **No more duplicates** - Theme-based clustering prevents duplicate narratives
2. **Better organization** - Narratives grouped by meaningful themes
3. **Lifecycle tracking** - Can identify emerging vs mature narratives
4. **Scalable** - Works with any number of articles
5. **Maintainable** - Predefined themes are easy to adjust

## Migration Notes

- Old narratives in database have `lifecycle: "unknown"` (4 narratives)
- New narratives use the lifecycle tracking system
- Articles now have `themes[]` field extracted by Claude
- Can run `scripts/reset_article_themes.py` to re-extract themes

## Next Steps

1. **Monitor in production** - Watch narrative quality over time
2. **Tune thresholds** - Adjust min_articles (currently 3) if needed
3. **Add more themes** - Expand THEME_CATEGORIES as crypto evolves
4. **UI updates** - Display lifecycle badges in frontend
5. **Alerts** - Notify on "hot" or "emerging" narratives

## Files Changed

- ✅ `src/crypto_news_aggregator/services/narrative_themes.py` (new)
- ✅ `src/crypto_news_aggregator/services/narrative_service.py` (refactored)
- ✅ `src/crypto_news_aggregator/db/operations/narratives.py` (updated)
- ✅ `src/crypto_news_aggregator/api/v1/endpoints/narratives.py` (updated)
- ✅ `scripts/test_theme_narratives.py` (new)
- ✅ `scripts/check_article_themes.py` (new)
- ✅ `scripts/reset_article_themes.py` (new)
